#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

# Load shared environment setup
source "$(dirname "$0")/env.sh"

# CRITICAL: Do NOT use VACUUM INTO here â€” it copies the entire DB and fills the disk.
# Instead, clean up any old backup copies that accumulated from previous crash loops.
if [[ "${ENVIRONMENT}" == "production" ]] && [[ -d "${DATA_DIR:-/data}" ]]; then
  backup_count=$(find "${DATA_DIR:-/data}" -name "production.db-*" -type f 2>/dev/null | wc -l)
  if [[ "$backup_count" -gt 0 ]]; then
    echo "[Boot] Cleaning up ${backup_count} old database backup(s) to free disk space..."
    find "${DATA_DIR:-/data}" -name "production.db-*" -type f -delete 2>/dev/null || true
  fi
  # Also clean WAL/SHM files if they're oversized (>50MB)
  for f in "${DATABASE_FILE:-/data/production.db}-wal" "${DATABASE_FILE:-/data/production.db}-shm"; do
    if [[ -f "$f" ]] && [[ $(stat -c%s "$f" 2>/dev/null || echo 0) -gt 52428800 ]]; then
      echo "[Boot] Removing oversized WAL/SHM file: $f"
      rm -f "$f"
    fi
  done
fi
 

# Install dependencies
echo "Installing dependencies..."
bun install

# Generate Prisma client and push schema if prisma is installed (database-auth skill)
if [[ -f "prisma/schema.prisma" ]]; then
  echo "Generating Prisma client..."
  bunx prisma generate
  echo "Pushing schema to database..."
  bunx prisma db push --accept-data-loss

  # Enable DB viewer (idempotent, safe to call multiple times)
  if [[ -n "${VIBECODE_PROJECT_ID:-}" ]]; then
    echo "Enabling database viewer..."
    curl -s -X POST "https://api.vibecodeapp.com/api/projects/${VIBECODE_PROJECT_ID}/cloud/db/enable" || true
  fi
fi

# Start server based on environment
# Use bun directly (not "bun run") so signals propagate correctly
if [[ "${ENVIRONMENT}" == "production" ]]; then
  echo "Starting server in production mode..."
  exec bun src/index.ts
else
  echo "Starting server in dev mode with hot reload..."
  exec bun --hot src/index.ts
fi
