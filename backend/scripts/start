#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

# Load shared environment setup
source "$(dirname "$0")/env.sh"

# CRITICAL: Do NOT use "VACUUM INTO" here.
# It copies the entire database, fills the disk, and causes infinite crash loops.
# Instead, clean up old backups to FREE disk space.
if [[ "${ENVIRONMENT}" == "production" ]]; then
  DATA_DIR="${DATA_DIR:-/data}"
  DATABASE_FILE="${DATABASE_FILE:-${DATA_DIR}/production.db}"

  # Delete old VACUUM backup copies that filled the disk
  find "${DATA_DIR}" -name "production.db-*" -type f -exec rm -f {} + 2>/dev/null || true
  find "${DATA_DIR}" -name "*.db-*" -not -name "*.db-wal" -not -name "*.db-shm" -type f -exec rm -f {} + 2>/dev/null || true

  # Remove WAL/SHM (SQLite recreates them)
  rm -f "${DATABASE_FILE}-wal" "${DATABASE_FILE}-shm" 2>/dev/null || true

  # Clear Prisma engine cache to free space for prisma generate
  rm -rf node_modules/.prisma 2>/dev/null || true
  rm -rf /tmp/prisma* /tmp/bun-* 2>/dev/null || true

  echo "[start] Disk cleanup done. Space available:"
  df -h "${DATA_DIR}" 2>/dev/null || df -h /
fi

# Install dependencies
echo "Installing dependencies..."
bun install

# Generate Prisma client and push schema if prisma is installed (database-auth skill)
if [[ -f "prisma/schema.prisma" ]]; then
  echo "Generating Prisma client..."
  bunx prisma generate
  echo "Pushing schema to database..."
  bunx prisma db push --accept-data-loss

  # Enable DB viewer (idempotent, safe to call multiple times)
  if [[ -n "${VIBECODE_PROJECT_ID:-}" ]]; then
    echo "Enabling database viewer..."
    curl -s -X POST "https://api.vibecodeapp.com/api/projects/${VIBECODE_PROJECT_ID}/cloud/db/enable" || true
  fi
fi

# Start server based on environment
# Use bun directly (not "bun run") so signals propagate correctly
if [[ "${ENVIRONMENT}" == "production" ]]; then
  echo "Starting server in production mode..."
  exec bun src/index.ts
else
  echo "Starting server in dev mode with hot reload..."
  exec bun --hot src/index.ts
fi
